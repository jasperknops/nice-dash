<?php

/**
 * Implementation of hook_menu
 */
function nice_dash_menu() {

 $items['admin/dashboard'] = array(
    'title' => 'Dashboard',
    'page callback' => 'nice_dash_dashboard_page',
    'access arguments' => array('view nice dashboard'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'nice_dash.pages.inc'
  );

 $items['admin/dashboard/view'] = array(
    'title' => 'View',
    'page callback' => 'nice_dash_dashboard_page',
    'access arguments' => array('view nice dashboard'),
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => -1,
    'file' => 'nice_dash.pages.inc'
  );

  $items['admin/dashboard/configure'] = array(
    'title' => 'Configure',
    'page callback' => 'nice_dash_dashboard_overview_page',
    'access arguments' => array('administer nice dashboard'),
    'type' => MENU_LOCAL_TASK,
    'file' => 'nice_dash.pages.inc'
  );

	$items['admin/dashboard/configure/overview'] = array(
    'title' => 'Overview',
    'page callback' => 'nice_dash_dashboard_overview_page',
    'access arguments' => array('administer nice dashboard'),
    'type' => MENU_DEFAULT_LOCAL_TASK,
		'weight' => -1,
    'file' => 'nice_dash.pages.inc'
  );

	$items['admin/dashboard/configure/create-dashboard'] = array(
		'title' => 'Create dashboard',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('nice_dash_dashboard_settings_form'),
		'access arguments' => array('administer nice dashboard'),
		'type' => MENU_LOCAL_TASK,
		'file' => 'nice_dash.pages.inc'
	);

	$items['admin/dashboard/configure/create-widget'] = array(
		'title' => 'Create widget',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('nice_dash_widget_settings_form'),
		'access arguments' => array('administer nice dashboard'),
		'type' => MENU_LOCAL_TASK,
		'file' => 'nice_dash.pages.inc'
	);

	 $items['admin/dashboard/configure/delete/%'] = array(
		'title' => 'Create new dashboard',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('nice_dash_dashboard_delete_form',4),
		'access arguments' => array('administer nice dashboard'),
		'type' => MENU_CALLBACK,
		'file' => 'nice_dash.pages.inc'
	);


 // Implement all the dashboard menu calls
 $dashboards = nice_dash_dashboards();

	if(count($dashboards) > 0){

	 $first = TRUE;

	 foreach($dashboards as $dashboard){
		 $items['admin/dashboard/configure/'.$dashboard['did'].'/edit'] = array(
		 'title' => 'Edit '.$dashboard['name'],
		 'page callback' => 'drupal_get_form',
		 'page arguments' => array('nice_dash_dashboard_settings_form',3),
		 'access arguments' => array('administer nice dashboard'),
		 'type' => MENU_LOCAL_TASK,
		 'file' => 'nice_dash.pages.inc'
		);

		if($first){
		 $type = MENU_DEFAULT_LOCAL_TASK;
		 $first = FALSE;
		}
		else {
		 $type = MENU_LOCAL_TASK;
		}

		$items['admin/dashboard/view/'.$dashboard['did']] = array(
		 'title' => $dashboard['name'],
		 'page callback' => 'nice_dash_dashboard_page',
		 'page arguments' => array(3),
		 'access arguments' => array('view nice dashboard'),
		 'type' => $type,
		 'weight' => $dashboard['weight'],
		 'file' => 'nice_dash.pages.inc'
		);
	 }
	}
  return $items;
}

/**
  *  Implementation of hook_init().
  */
function nice_dash_init() {
  if (isset($_SESSION['admin_dashboard_redirect'])) {
    unset($_SESSION['admin_dashboard_redirect']);
    drupal_goto('admin/dashboard');
  }
}

/**
 * Implementation of hook_user
 */
function nice_dash_user($op, &$edit, &$account, $category = NULL){
  switch ($op) {
    case 'login':
    if (user_access('view admindashboard')) {
      $_SESSION['admin_dashboard_redirect'] = true;
    }
    break;
  }
}

/**
 * Implementation of hook_perm
 */
function nice_dash_perm() {
  return array('administer nice dashboard','view nice dashboard');
}

/**
 * Implementation of hook_theme()
 */
function nice_dash_theme($existing, $type, $theme, $path){
  $path = drupal_get_path('module', 'nice_dash');

  return array(
    'nice_dash_component' => array(
      'arguments' => array('title' => NULL, 'description' => NULL, 'content' => NULL),
      'template' => 'nice-dash-dashboard-component',
      'file' => 'theme.inc',
      'path' => $path .'/theme',
    ),
    'nice_dash_page' => array(
      'arguments' => array('regions' => NULL),
      'template' => 'nice-dash-dashboard',
      'file' => 'theme.inc',
      'path' => $path .'/theme',
    ),
     'nice_dash_settings_form' => array(
      'arguments' => array('form' => NULL),
      'template' => 'nice-dash-dashboard-settings-form',
      'file' => 'theme.inc',
      'path' => $path .'/theme',
    ),
  );
}

/**
 * Implementation of hook_views_api().
 */
function nice_dash_views_api() {
  return array(
    'api' => 2,
    'path' => drupal_get_path('module', 'nice_dash'),
  );
}

/**
 * Implementation of hook_block
 */
function nice_dash_block($op = 'list', $delta = 0, $edit = array()) {
  switch ($op) {
    case 'list':
      $blocks['dashboard'] = array(
        'info' => t('Dashboard'),
        'admin' => TRUE,
        'cache' => FALSE,
        'weight' => -1,
      );
      return $blocks;
    case 'view': default:
      module_load_include('inc', 'nice_dash', 'nice_dash.blocks');
      switch ($delta) {
        case 'dashboard':
          $block['subject'] = t('Dashboard');
          $block['content'] = nice_dash_dashboard_block();
          break;
      }
      return $block;
  }
}

/**
 * Dashboard regions
 *
 * @return: An array of layout regions available for widgets
 */
function nice_dash_regions() {
  return array(
    'header' => t('Header'),
    'left' => t('Left'),
    'right' => t('Right'),
    'footer' => t('Footer'),
    'disabled' => t('Disabled')
  );
}

/**
 * Fetch widget values
 */
function nice_dash_widget_values($wid, $did){
 // Fetch wid
 //$wid = nice_dash_widget_wid($key);

 //
 $result = db_query("SELECT region, weight FROM {nice_dash_config} WHERE wid = %d AND did = %d", $wid, $did);
 while($row = db_fetch_array($result)){
   return $row;
 }
 // If empty
 return nice_dash_widget_default_values();
}

/**
 * Fetch all widgets
 */
function nice_dash_widgets(){

 // @TODO add caching !!!!


 // Fetch code widgets
 $widgets = module_invoke_all('nice_dash_widgets');

 // Save them if they don't exist
 foreach($widgets as $key => $value){

	 $wid = nice_dash_widget_wid($key);

	 if(!$wid){
		$widget = new stdClass();
		$widget->custom = 0;
		$widget->widget_key = $key;
		$widget->title = $value['title'];
		$widget->description = '';

		drupal_write_record('nice_dash_widgets', $widget);
	 }
 }

 // Fetch db widgets
 $result = db_query("SELECT * FROM {nice_dash_widgets}");
 $widgets = array();
 while($row = db_fetch_array($result)){
	$widgets[] = $row;
 }
 return $widgets;
}

function nice_dash_widget_wid($key){
 return db_result(db_query("SELECT wid FROM {nice_dash_widgets} WHERE widget_key = '%s'", $key));
}

/**
 * Default widget values
 */
function nice_dash_widget_default_values(){
 return array(
   'weight' => 0,
   'region' => 'disabled'
 );
}

/**
 * Fetch dashboards
 */
function nice_dash_dashboard_values($did){
	$result = db_query("SELECT * FROM {nice_dash_dashboards} WHERE did = %d", $did);
	$rows = array();

	while ($row = db_fetch_array($result)){
		return $row;
	}
}

/**
 * Fetch dashboards
 */
function nice_dash_dashboards(){
	$result = db_query("SELECT * FROM {nice_dash_dashboards} ORDER BY weight ASC");
	$rows = array();

	while ($row = db_fetch_array($result)){
	 $rows[] = $row;
	}

	return $rows;
}

/**
 * Delete dashboard
 */
function nice_dash_remove_dashboard($did){
	db_query("DELETE FROM {nice_dash_dashboards} WHERE did = %d", $did);
	db_query("DELETE FROM {nice_dash_widgets} WHERE did = %d", $did);
	// Clear them from the menu
	module_invoke('menu','rebuild');
}

/**
 * Get the custom widget block
 */
function nice_dash_get_custom_widget($bid){
  $split = explode('-', $bid, 2);
  if (count($split) === 2) {
		 list($module, $delta) = $split;
		 $block = module_invoke($module, 'block', 'view', $delta);
		 if (!empty($block['content'])) {
			 if ($module === 'block') {
				 global $theme;
				 $block['subject'] = db_result(db_query("SELECT title FROM {blocks} WHERE module = 'block' AND delta = '%s'", $delta));
			 }
		 }
	}
	return $block['content'];
}
